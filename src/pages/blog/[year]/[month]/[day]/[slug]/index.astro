---
import { getCollection, render } from 'astro:content'
import TopicPage from '@/components/TopicPage.astro'

export async function getStaticPaths() {
  const paths = []
  for (const post of Object.values(await getCollection('blog'))) {
    if (!post.data.published) continue
    const year = post.data.published.getFullYear().toString()
    const month = (post.data.published.getMonth() + 1)
      .toString()
      .padStart(2, '0')
    const day = post.data.published.getUTCDate().toString().padStart(2, '0')
    const { slug } = post.data

    paths.push({ params: { year, month, day, slug }, props: { post } })
  }
  return paths
}

async function getPost(year: string, month: string, day: string, slug: string) {
  const posts = await getCollection('blog')
  return posts.find((post) => {
    const postDate = post.data.published
    if (!postDate) return false
    return (
      postDate.getFullYear() === parseInt(year) &&
      postDate.getMonth() + 1 === parseInt(month) &&
      postDate.getDate() === parseInt(day) &&
      post.data.slug === slug
    )
  })
}

const { year, month, day, slug } = Astro.params
const post = Astro.props.post || (await getPost(year, month, day, slug))
const { Content } = await render(post)
---
<TopicPage topic={post} content={Content} singleColumn={true} />
